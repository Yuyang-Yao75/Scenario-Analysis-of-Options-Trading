# 情景分析：期权持仓风险评估

该项目用于对期权组合进行情景分析，评估在标的价格和波动率变化下的盈亏、保证金以及希腊值暴露情况。工具基于 **iFinD** 数据接口，结合 `pandas`、`numpy`、`scipy` 与 `xlsxwriter` 等库，实现自动化的风险测算与报表生成。
本项目采用MIT License进行许可-请参阅[License](./LICENSE)文件获取详细信息。


## 功能特点

* **一键获取并校验持仓数据（iFinD 接入 + 容错备份）**
  通过 `THS_iFinDLogin` 登录与 `THS_BD/THS_DR` 批量拉取必需字段（标的、收盘价、执行价、到期日、剩余交易日、合约乘数等），自动**合并到本地持仓**。内置 `check_and_backup_out` 完整性检查：一旦发现缺失值即**落盘备份**并返回**可读性强的缺失列报告**（缺失比例、修复建议），保证数据质量与可追溯性。

* **交易时段感知与日期语义统一**
  支持「盘前 / 盘中 / 盘后」三种模式：自动在**日期参数与剩余交易日**计算中做“是否包含当日”的转换（同花顺剩余交易日含当日，脚本在不同环节做 -1/244 的精细校正），**避免 T 与交易日定义错配**带来的系统性偏差。

* **智能估计平值标的价（去噪版收盘价）**
  对欧式合约，按**标的分组只计算一次**“平值标的价”：

  * 依据标的收盘价，**自适应挑选最接近的 5 档执行价**，分别匹配看涨/看跌；
  * 利用**看涨–看跌平价**反推 5 个“隐含标的价”，**取均值平滑单点噪声**；
  * 异常与数据不齐全时给出**告警但不中断**，默认回退为 `NaN`，确保流程稳健。

* **双引擎隐含波动率求解（欧式 Newton + 美式 Bisection）**

  * **欧式**：基于 Black–Scholes，使用牛顿法迭代，同时加入**无套利价格边界**检测与**平价修正**（市价越界时，尝试用对端合约+平价重构），并在 **Vega 过小** 或 **收敛异常**时进行**截断与回退**，保证结果稳定。
  * **美式**：采用 **Barone–Adesi–Whaley (BAW)** 定价，外层**二分法**反推波动率，极端情况下**安全回退**，避免抖动。

* **统一定价内核，天然支持二维情景广播计算**

  * `bs_price` 与 `baw_american_option_price` 对 **标的变动（ds）× 波动率变动（dv）** 的 11×11 网格**向量化广播**，无需显式循环即可得到**全矩阵价格**；
  * 美式临界价格 `critical_price` 采用**只对未收敛元素迭代**的策略，并行化处理、**逐步松弛迭代**与**相对误差阈值**控制，计算效率与收敛稳健性兼顾。

* **两维情景 P\&L 热力矩阵（合约 → 标的 → 组合）**

  * 对每张期权合约计算在 **S 变动 × IV 变动** 下的价格与 **P\&L**（乘以持仓数量与合约乘数）；
  * 按**标的资产聚合**并进一步汇总到**组合层**，形成**多 Sheet 输出**：单标的情景表 + `all_scenario` 全组合表，支持交易盘面快速定位风险贡献。

* **保证金情景分析（交易所规则内建）**

  * **A 股期权**：按上交所/深交所/CFFEX **不同保证金公式**计算；
  * **期货交易所**：自动调用标的期货空头保证金比例（iFinD 字段 `ths_contract_short_deposit_future`），并与**虚值额**、**权利金**联动，通过**两条约束的最大值**给出更贴近风控口径的保证金估算；
  * 支持按标的和组合层级的**情景保证金曲线**，与 P\&L/Greeks 同屏对照，更利于**保证金缺口**预判。

* **欧/美式分流的 Greeks 计算（解析 + 差分）**

  * **欧式**：Delta/Gamma/Vega/Theta 全解析解，考虑 **日化换算**（ANN\_TRADING\_DAYS=244）与度量单位（Vega 以“每 1% 变化”为标准）。
  * **美式**：在 BAW 定价基础上采用**中心差分**与**一日时间步进**，Delta/Gamma/Vega/Theta 全量估算，**贴合实际风控**。
  * 按**标的聚合**并输出**Greeks 热力矩阵**（ds × dv），另提供**全组合**总 Greeks，便于做**情景下的敞口对冲与限额管理**。

* **结果即文档：结构化 Excel 报告（可直接给交易/风控）**

  * 自动按日期新建文件夹与 Excel：

    * `期权持仓表完整`：数据扩充与清洗后的**权威版本**；
    * 各标的 Sheet：**P\&L 情景表 + 保证金曲线 + Greeks 热力矩阵**；
    * `all_scenario`：**全组合** P\&L / 保证金 / Greeks 汇总；
  * 细节打磨：**斜线表头**、行列宽与数值格式、情景标签（如 `+5%`、`-10vol`）统一规范，降低误读成本。

* **稳健性的工程化细节**

  * **会话合法性校验**、**交易所后缀映射**、**只对未收敛元素迭代**、**价格越界平价修正**、**Vega 过小与负波动率防护**、**异常打印但不中断主链路**；
  * **按标的去重计算**（如平值标的价）减少冗余请求与重复计算；
  * **类型注解 + 明确的函数边界**（登录、载入、估计、定价、Greeks、保证金、导出），使得模块可替换、易单测、好维护。

* **默认约定与适用范围清晰**

  * 年化交易日 `ANN_TRADING_DAYS = 244`；
  * 欧式默认 **q=0**，美式期货期权默认 **q=r**（持有成本设定），与主流实务口径一致；
  * 适用于 **上交所/深交所 ETF 期权** 与 **国内期货交易所美式期权** 的情景、Greeks 与保证金测算；可据此拓展到更多品种与场景。

* **开箱即用，也便于扩展**

  * 网格步长、情景范围（`generate_grid`）、无风险利率、风控参数均为**配置变量**；
  * 定价核与风控核分离，后续可**接入自研波动率曲面**、**引入跳跃/局部波动率模型**，或将输出换为 **数据库/仪表盘** 而非 Excel，无需重写主流程。

## 输入 / 输出（简版）

**输入：**

* 本地持仓表 `期权持仓表.csv`

  * 必含列：`代码`、`数量`（空头为负、 多头为正）
* 运行环境会从 iFinD 拉取所需的**标的/期权基础字段**、**行情**与**保证金参数**；
* 可配置参数：

  * `SESSION ∈ {盘前, 盘中, 盘后}`（驱动日期与剩余交易日口径）
  * `r`（无风险利率，默认 `0.02`）
  * `ANN_TRADING_DAYS=244`、网格步长 `generate_grid(ds_steps=11, dv_steps=11)` 等。

**输出：**

* 目录：`YYYY-MM-DD/`
* 文件：`YYYY-MM-DD_情景分析.xlsx`，包含以下 Sheet：

  1. **期权持仓表完整**：原持仓 + 拉取/扩充字段 + 平值标的价 + 隐含波动率；
  2. **各标的**：

     * P\&L 情景矩阵（`S: -10% ~ +10%` × `IV: -10vol ~ +10vol`）
     * 保证金情景（同一张表尾部纵向罗列）
     * Greeks 情景矩阵（Delta/Gamma/Vega/Theta 的 `ds × dv` 热力表）；
  3. **all\_scenario**：

     * 全组合 P\&L 情景矩阵
     * 全组合保证金情景表
     * 总 Delta/Gamma/Vega/Theta 情景矩阵。
## 环境要求
- Python 3.8+
- 主要依赖：`pandas`、`numpy`、`scipy`、`matplotlib`、`xlsxwriter`、`iFinDPy`
- 需拥有有效的 iFinD 账号与权限

## 安装
```bash
pip install pandas numpy scipy matplotlib xlsxwriter iFinDPy
```
## 使用方法

1. 在项目根目录准备 `期权持仓表.csv`，其中包含期权合约代码与数量。  
2. 通过设置 `SESSION` 变量选择分析时段（盘前、盘中、盘后）。  
3. 运行主脚本：  

   ```bash
   python 情景分析.py
   ```
4.	程序会根据当前日期生成 YYYY-MM-DD/ 目录，并在其中输出情景分析报表。
## 文件结构
```bash
情景分析.py          # 主程序
期权持仓表.csv        # 输入持仓表
YYYY-MM-DD/          # 每日输出目录
└── YYYY-MM-DD_情景分析.xlsx
README.md           # 项目说明
```

## 注意事项
- 首次运行或更新 期权持仓表.csv 后，请删除自动生成的 期权持仓表备份.csv，以避免读取旧数据。
- 盘中/盘前进行情景分析，请在数据源就绪后执行。
- 含有持仓与敏感度等信息，使用时应注意保密。